from django.apps import apps
from django.core.management import BaseCommand, CommandError

from stdimage.utils import render_variations


class Command(BaseCommand):
    help = "Renders all variations of a StdImageField."

    def add_arguments(self, parser):
        parser.add_argument(
            "field_path", nargs="+", type=str, help="<app.model.field app.model.field>"
        )
        parser.add_argument(
            "--replace",
            action="store_true",
            dest="replace",
            default=False,
            help="Replace existing files.",
        )

        parser.add_argument(
            "-i",
            "--ignore-missing",
            action="store_true",
            dest="ignore_missing",
            default=False,
            help="Ignore missing source file error and skip render for that file",
        )

    def handle(self, *args, **options):
        replace = options["replace"]
        ignore_missing = options["ignore_missing"]
        routes = options["field_path"]
        for route in routes:
            try:
                app_label, model_name, field_name = route.rsplit(".", 2)
            except ValueError:
                raise CommandError(
                    f"Error parsing field_path '{route}'. Use format "
                    "<app.model.field app.model.field>."
                )
            model_class = apps.get_model(app_label, model_name)
            field = model_class._meta.get_field(field_name)

            queryset = model_class._default_manager.exclude(
                **{f"{field_name}__isnull": True}
            ).exclude(**{field_name: ""})
            obj = queryset.first()
            do_render = True
            if obj:
                f = getattr(obj, field_name)
                do_render = f.field.render_variations
            count = queryset.count()
            images = queryset.values_list(field_name, flat=True).iterator()

            self.render(field, images, count, replace, ignore_missing, do_render)

    def render(self, field, images, count, replace, ignore_missing, do_render):
        kwargs_list = (
            dict(
                file_name=file_name,
                do_render=do_render,
                variations=field.variations,
                replace=replace,
                storage=field.storage,
                field_class=field.attr_class,
                ignore_missing=ignore_missing,
            )
            for file_name in images
        )
        try:
            import progressbar
        except ImportError:
            for file_name in map(render_field_variations, kwargs_list):
                self.stdout.write(f"Processing: {file_name}", self.style.NOTICE)
        else:
            with progressbar.ProgressBar(
                max_value=count,
                widgets=(
                    progressbar.RotatingMarker(),
                    " | ",
                    progressbar.AdaptiveETA(),
                    " | ",
                    progressbar.Percentage(),
                    " ",
                    progressbar.Bar(),
                ),
            ) as bar:
                for _ in map(render_field_variations, kwargs_list):
                    bar += 1


def render_field_variations(kwargs):
    ignore_missing = kwargs.pop("ignore_missing")
    do_render = kwargs.pop("do_render")
    try:
        if callable(do_render):
            kwargs.pop("field_class")
            do_render = do_render(**kwargs)
        if do_render:
            render_variations(**kwargs)
    except FileNotFoundError as e:
        if not ignore_missing:
            raise CommandError(
                "Source file was not found, terminating. "
                "Use -i/--ignore-missing to skip this error."
            ) from e
    return kwargs["file_name"]
